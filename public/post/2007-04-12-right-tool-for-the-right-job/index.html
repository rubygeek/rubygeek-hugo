<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Right Tool for the Right Job - Rubygeek</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Right Tool for the Right Job" />
<meta property="og:description" content="On one of my projects the requirements was to take two csv files, one with words and data and one with words. The goal is to use the list of words to retrieve the data from the other. Long-term storage for the datasets is not needed, so I didn&#39;t see a reason to put in a database. Typically the language used for this company is PHP (though I have sneaked in a few ruby scripts." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rubygeek.com/post/2007-04-12-right-tool-for-the-right-job/" />
<meta property="article:published_time" content="2007-04-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2007-04-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Right Tool for the Right Job"/>
<meta name="twitter:description" content="On one of my projects the requirements was to take two csv files, one with words and data and one with words. The goal is to use the list of words to retrieve the data from the other. Long-term storage for the datasets is not needed, so I didn&#39;t see a reason to put in a database. Typically the language used for this company is PHP (though I have sneaked in a few ruby scripts."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/main.css" />

	
		<script src="http://rubygeek.comjs/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="http://rubygeek.com">Rubygeek</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">12</span>
							<span class="rest">Apr 2007</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Right Tool for the Right Job</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>On one of my projects the requirements was to take two csv files, one with words and data and one with words. The goal is to use the list of words to retrieve the data from the other. Long-term storage for the datasets is not needed, so I didn't see a reason to put in a database. Typically the language used for this company is PHP (though I have sneaked in a few ruby scripts.. shhhh) so my first try was to load each file into an array in memory and do a lookup. It worked fine for my sample files but croaked when I fed it the real data. My real data file was 180k some words and my word list was 400k words. So, I tried using a temporary table. I started it when I left for the day and it was still going the next morning. This was unbearable slow and never actually completed. I could have probably tried to optimize or choose different table types, but I didn't&hellip;because I was thinking hmmmmm&hellip; wonder if Perl will be faster? It was, not only did it complete &mdash; but finished in minutes (with printing each word out to the display) or in seconds (in a more silent mode). I showed the people who would be using it – they were amazed. This sort of thing takes hours in excel and crashes sometimes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e"># load data list into hash</span>
$parser <span style="color:#f92672">=</span> Parse::CSV<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#66d9ef">new</span>( binary <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>, file <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> $infile_name );
<span style="color:#66d9ef">my</span> %DATA <span style="color:#f92672">=</span> {};
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;\n\nNow indexing data file\n&#34;</span>;
<span style="color:#66d9ef">while</span> ( $line <span style="color:#f92672">=</span> $parser<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fetch ) {
	<span style="color:#66d9ef">next</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>$line;
	$word <span style="color:#f92672">=</span> shift @$line;	
	<span style="color:#66d9ef">next</span> <span style="color:#66d9ef">if</span> ( (<span style="color:#f92672">!</span>defined($word)) <span style="color:#f92672">or</span> ($word <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#39;&#39;</span>));
	$DATA{$word} <span style="color:#f92672">=</span> $line;
	<span style="color:#66d9ef">print</span> $verbose ? <span style="color:#e6db74">&#34;Indexing $word\n&#34;</span> : <span style="color:#e6db74">&#39;.&#39;</span>;
} 
</code></pre></div><p>The files sometimes have foreign characters in it so I open it in binary mode. <!-- raw HTML omitted -->Parse::CSV<!-- raw HTML omitted --> is a wrapper for <!-- raw HTML omitted -->Text::CSV_XS<!-- raw HTML omitted --> class and is much easier to use. Its written by <!-- raw HTML omitted -->Adam Kennedy<!-- raw HTML omitted --> and I had a question about it and was able to find him in IRC and ask him myself, and got some help from someone else in the room too &ndash; pretty cool! Back to the code, I skip if the line is not defined, shift off the first element of the array. The fetch method always returns an array reference, so I must prefix it with @ to access it as an array and shift off the first element. If thats not defined or blank, I use as the key to store the reference to the array. If verbose option was used, I display a longer notification to the user, otherwise I display just a period. That way the user knows its working!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#setup excel file</span>
<span style="color:#66d9ef">my</span> $workbook <span style="color:#f92672">=</span> Spreadsheet::WriteExcel<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#66d9ef">new</span>($outfile_name);
<span style="color:#66d9ef">my</span> $worksheet <span style="color:#f92672">=</span> $workbook<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>add_worksheet();

<span style="color:#75715e">#process word list</span>

$parser <span style="color:#f92672">=</span> Parse::CSV<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#66d9ef">new</span>( binary <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>, file <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> $wordfile_name );
<span style="color:#66d9ef">my</span> $row_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">my</span> (@row, $row_ref);
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;\nNow starting lookup...\n&#34;</span>;
<span style="color:#66d9ef">while</span> ( $line <span style="color:#f92672">=</span> $parser<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fetch ) {
	@row <span style="color:#f92672">=</span> ();
	$word <span style="color:#f92672">=</span> shift @$line;
	<span style="color:#66d9ef">next</span> <span style="color:#66d9ef">if</span> ( (<span style="color:#f92672">!</span>defined($word)) <span style="color:#f92672">or</span> ($word <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#39;&#39;</span>));

	<span style="color:#66d9ef">if</span> (exists $DATA{$word}) {
		<span style="color:#75715e">#word found</span>
		$row_ref <span style="color:#f92672">=</span> $DATA{$word};  <span style="color:#75715e">#get ref to array </span>
	  	<span style="color:#66d9ef">print</span> $verbose ? <span style="color:#e6db74">&#34;Found $word\n&#34;</span> : <span style="color:#e6db74">&#39;+&#39;</span>;
		push @row, $word;
		push @row, @$row_ref;
		$worksheet<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>write_row($row_count, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">\</span>@row);
	} <span style="color:#66d9ef">else</span> {
	  	<span style="color:#66d9ef">print</span> $verbose ? <span style="color:#e6db74">&#34;Not Found $word\n&#34;</span> : <span style="color:#e6db74">&#39;-&#39;</span>;
		$worksheet<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>write_row($row_count, <span style="color:#ae81ff">0</span>, [$word, <span style="color:#e6db74">&#39;not found&#39;</span>]);
	}
	$row_count<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
}
</code></pre></div><p>Similar to the loading of the hash, I open the file with Parser::CSV as before. I initialize my variables and set a row_count used to write to the excel file. This data file is supposed to be a single column list of words, so I could probably get away with just doing a simple file read but just in case I treat as a CSV file. Once I get the word variable, I see if it exists as a key in my %DATA hash. <!-- raw HTML omitted -->Funny thing about Perl regarding hashes and arrays – when referring to the whole thing you use % for hash, @ for array. But when referring to a particular element, you use $. Kinda funny but in a way makes sense&hellip;hehe.<!-- raw HTML omitted --> :P I simplified this code a bit so you get the concept and these lines better no doubt. I used @row as a temporary holder for the data I want to write to the excel file, I had some other code here I took out which had more to do with the @row. Finally I write the row array to the the excel file. The method requires an array ref, and @row gives me a reference.</p>
<p>Thats basically it. The loading of %DATA hash is of course, dependent on how much memory you have. If you have problems you could try tieing it to a DB file:</p>
<pre><code>use DB_File;

tie %DATA, 'DB_File', 'output.db' or die ('cannot open output.db');
</code></pre><p>Building a DB file also has the advantage of persistence. If you need to run a lot of lookups, multiple times you may be interested in using it. It will be slower to some extent, but it will work! :)</p>
<p>My script could probably be optimized some and perhaps <!-- raw HTML omitted -->golfed<!-- raw HTML omitted --> some which could make it faster. But I try and write Perl in english, at least for the first pass. Then perhaps I can use the shortcuts and see if it runs faster. This was a fun project and I got to learn more Perl. My friends <!-- raw HTML omitted -->Liz<!-- raw HTML omitted --> and Yaakov helped me and I thank them :)</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
