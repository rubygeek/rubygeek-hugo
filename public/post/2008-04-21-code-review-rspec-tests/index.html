<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Code Review: Rspec Tests - Rubygeek</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Code Review: Rspec Tests" />
<meta property="og:description" content="I am writing a rails application for my mom to enter her bakery orders for her business. The Order page has a form to search or add a new customer, so i can streamline the process as much as possible. In the Order create method, I either get a customer array or a customer ID.
Here&#39;s the order create method in the controller:
def create new_customer = params[:order][:customer_id].blank? ? true : false if new_customer @customer = Customer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rubygeek.com/post/2008-04-21-code-review-rspec-tests/" />
<meta property="article:published_time" content="2008-04-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2008-04-21T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Code Review: Rspec Tests"/>
<meta name="twitter:description" content="I am writing a rails application for my mom to enter her bakery orders for her business. The Order page has a form to search or add a new customer, so i can streamline the process as much as possible. In the Order create method, I either get a customer array or a customer ID.
Here&#39;s the order create method in the controller:
def create new_customer = params[:order][:customer_id].blank? ? true : false if new_customer @customer = Customer."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/main.css" />

	
		<script src="http://rubygeek.comjs/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="http://rubygeek.com">Rubygeek</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">21</span>
							<span class="rest">Apr 2008</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Code Review: Rspec Tests</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>I am writing a rails application for my mom to enter her bakery orders for her business. The Order page has a form to search or add a new customer, so i can streamline the process as much as possible. In the Order create method, I either get a customer array or a customer ID.</p>
<p>Here's the order create method in the controller:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">create</span>
    
    new_customer <span style="color:#f92672">=</span> params<span style="color:#f92672">[</span><span style="color:#e6db74">:order</span><span style="color:#f92672">]</span><span style="color:#f92672">[</span><span style="color:#e6db74">:customer_id</span><span style="color:#f92672">]</span><span style="color:#f92672">.</span>blank? ? <span style="color:#66d9ef">true</span> : <span style="color:#66d9ef">false</span>
    
    <span style="color:#66d9ef">if</span> new_customer
      @customer <span style="color:#f92672">=</span> <span style="color:#66d9ef">Customer</span><span style="color:#f92672">.</span>create(params<span style="color:#f92672">[</span><span style="color:#e6db74">:customer</span><span style="color:#f92672">]</span>) 
      <span style="color:#66d9ef">if</span> @customer<span style="color:#f92672">.</span>valid?
        @customer<span style="color:#f92672">.</span>orders<span style="color:#f92672">.</span>create(params<span style="color:#f92672">[</span><span style="color:#e6db74">:order</span><span style="color:#f92672">]</span>)        
        flash<span style="color:#f92672">[</span><span style="color:#e6db74">:notice</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;New customer was added and order was created successfully&#39;</span> 
        redirect_to orders_url
      <span style="color:#66d9ef">else</span>
        flash<span style="color:#f92672">[</span><span style="color:#e6db74">:notice</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Please fill in all required fields&#39;</span>
        render <span style="color:#e6db74">:action</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#39;new&#39;</span>
      <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">else</span>
      @customer <span style="color:#f92672">=</span> <span style="color:#66d9ef">Customer</span><span style="color:#f92672">.</span>find params<span style="color:#f92672">[</span><span style="color:#e6db74">:order</span><span style="color:#f92672">]</span><span style="color:#f92672">[</span><span style="color:#e6db74">:customer_id</span><span style="color:#f92672">]</span> 
      @customer<span style="color:#f92672">.</span>orders<span style="color:#f92672">.</span>create(params<span style="color:#f92672">[</span><span style="color:#e6db74">:order</span><span style="color:#f92672">]</span>)
      flash<span style="color:#f92672">[</span><span style="color:#e6db74">:notice</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Order was successfully created.&#39;</span>
      redirect_to orders_url
    <span style="color:#66d9ef">end</span>

 <span style="color:#66d9ef">end</span>
</code></pre></div><p>Ok? anybody see a better way to do that?  It took me awhile to figure out the right branching. Now for my rspec tests. This can take two paths &ndash; new customer or existing customer.</p>
<p>Test for New Customer:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">describe <span style="color:#66d9ef">OrdersController</span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">handling POST /orders with a new customer</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>

  before <span style="color:#66d9ef">do</span>
    @order <span style="color:#f92672">=</span> mock_model(<span style="color:#66d9ef">Order</span>, <span style="color:#e6db74">:to_param</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>)
    
    <span style="color:#66d9ef">Order</span><span style="color:#f92672">.</span>stub!(<span style="color:#e6db74">:create</span>)<span style="color:#f92672">.</span>and_return(@order)
    
    @params <span style="color:#f92672">=</span> {<span style="color:#e6db74">:customer_id</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">nil</span>} 
    
    @customer <span style="color:#f92672">=</span> mock_model(<span style="color:#66d9ef">Customer</span>, <span style="color:#e6db74">:to_param</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>)
    @customer<span style="color:#f92672">.</span>stub!(<span style="color:#e6db74">:orders</span>)<span style="color:#f92672">.</span>and_return(<span style="color:#66d9ef">Order</span>)
    <span style="color:#66d9ef">Customer</span><span style="color:#f92672">.</span>stub!(<span style="color:#e6db74">:create</span>)<span style="color:#f92672">.</span>and_return(@customer)
  <span style="color:#66d9ef">end</span>
  
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">post_with_successful_save</span>
    @customer<span style="color:#f92672">.</span>should_receive(<span style="color:#e6db74">:valid?</span>)<span style="color:#f92672">.</span>and_return(<span style="color:#66d9ef">true</span>)
    post <span style="color:#e6db74">:create</span>, <span style="color:#e6db74">:order</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> @params
  <span style="color:#66d9ef">end</span>
  
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">post_with_failed_save</span>
    @customer<span style="color:#f92672">.</span>should_receive(<span style="color:#e6db74">:valid?</span>)<span style="color:#f92672">.</span>and_return(<span style="color:#66d9ef">false</span>)
    post <span style="color:#e6db74">:create</span>, <span style="color:#e6db74">:order</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> @params
  <span style="color:#66d9ef">end</span>

  it <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">should create a new customer</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">Customer</span><span style="color:#f92672">.</span>should_receive(<span style="color:#e6db74">:create</span>)<span style="color:#f92672">.</span>with(anything())<span style="color:#f92672">.</span>and_return(@customer)   
    post_with_successful_save
  <span style="color:#66d9ef">end</span>
  
  it <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">should create a new order</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">Order</span><span style="color:#f92672">.</span>should_receive(<span style="color:#e6db74">:create</span>)<span style="color:#f92672">.</span>with(anything())<span style="color:#f92672">.</span>and_return(@order)  
    post_with_successful_save
  <span style="color:#66d9ef">end</span>

  it <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">should redirect to the new order on successful save</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>
    post_with_successful_save
    response<span style="color:#f92672">.</span>should redirect_to(orders_url)
  <span style="color:#66d9ef">end</span>

  it <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">should re-render &#39;new&#39; on failed save</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">do</span>
    post_with_failed_save
    response<span style="color:#f92672">.</span>should render_template(<span style="color:#e6db74">&#39;new&#39;</span>)
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Hows that look? do I catch all the cases for the New Customer scenario?</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
