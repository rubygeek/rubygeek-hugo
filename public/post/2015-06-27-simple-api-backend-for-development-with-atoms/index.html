<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Simple API Backend for Development with Atoms - Rubygeek</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Simple API Backend for Development with Atoms" />
<meta property="og:description" content="When playing with liberator I wished I had a simple way to skip over having a database for playing around with data and I also wanted to write about Liberator but not have to get bogged down with Database stuff. I wrote a simple API backend that uses atoms and I&#39;ll write about this first, and this will be followed with some posts on liberator and what is the simplest setup and gradually building on." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rubygeek.com/post/2015-06-27-simple-api-backend-for-development-with-atoms/" />
<meta property="article:published_time" content="2015-06-27T20:52:27+00:00" />
<meta property="article:modified_time" content="2015-06-27T20:52:27+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Simple API Backend for Development with Atoms"/>
<meta name="twitter:description" content="When playing with liberator I wished I had a simple way to skip over having a database for playing around with data and I also wanted to write about Liberator but not have to get bogged down with Database stuff. I wrote a simple API backend that uses atoms and I&#39;ll write about this first, and this will be followed with some posts on liberator and what is the simplest setup and gradually building on."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/main.css" />

	
		<script src="http://rubygeek.comjs/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="http://rubygeek.com">Rubygeek</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">27</span>
							<span class="rest">Jun 2015</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Simple API Backend for Development with Atoms</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>When playing with liberator I wished I had a simple way to skip over having a database for playing around with data and I also wanted to write about Liberator but not have to get bogged down with Database stuff. I wrote a simple API backend that uses atoms and I'll write about this first, and this will be followed with some posts on liberator and what is the simplest setup and gradually building on.</p>
<p>As you may know, <a href="https://clojuredocs.org/clojure.core/atom">Atoms</a> are a way to maintain state, a placeholder for changeable data. In my simple-api I defined two atoms, one for the data, an empty map and another for the <code>auto_increment</code> number.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defonce </span>id-seq (<span style="color:#a6e22e">atom</span> <span style="color:#ae81ff">0</span>))
(<span style="color:#66d9ef">defonce </span>recipes (<span style="color:#a6e22e">atom</span> (<span style="color:#a6e22e">array-map</span>)))
</code></pre></div><p>Since I only want to define them once (and they will reset everytime this file is reloaded) I used <code>defonce</code>. Once I run that, I can see the values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">simple-api.models&gt; <span style="color:#f92672">@</span>recipes
{}
simple-api.models&gt; <span style="color:#f92672">@</span>id-seq
<span style="color:#ae81ff">0</span>
</code></pre></div><p>The @ is a reader macro that de-references the atom. Now we need a function to add a new recipe. For fun I used <a href="https://github.com/Prismatic/schema">Prismatic Schema</a> which I wrote about <a href="http://www.clojuregeek.com/2015/04/18/using-lein-try-to-learn-prismatic-schema/">here</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defn </span>add! [new-recipe]
  (<span style="color:#66d9ef">let </span>[id (<span style="color:#a6e22e">swap!</span> id-seq inc)
        new-recipe-with-id (assoc new-recipe <span style="color:#e6db74">:id</span> id)
        recipe (<span style="color:#a6e22e">coerce!</span> Recipe new-recipe-with-id)]
    (<span style="color:#a6e22e">swap!</span> recipes assoc id recipe)
      recipe))

</code></pre></div><p>Here's what each line of the function is doing:</p>
<p>1: Incoming map of recipe data comes in as <code>new-recipe</code>.</p>
<p>2: Change the value of the <code>id-seq</code> atom using <a href="https://clojuredocs.org/clojure.core/swap!">swap!</a>. Swap! has always felt a bit strange, you have to pass in a function to change the value&hellip; you can't just pass in say <code>5</code> (5 is not a function..derp, to just replace the value use <a href="https://clojuredocs.org/clojure.core/reset!">reset!</a>). In this case <a href="https://clojuredocs.org/clojure.core/inc">inc</a> works fine and is what we need.</p>
<p>3: Create a <code>new-recipe-with-id</code> by adding in the id as a key/value pair by using <a href="https://clojuredocs.org/clojure.core/assoc">assoc</a>.</p>
<p>4: Take the <code>new-recipe-with-id</code> and use Coerce! returns a validated data structure or throws an exception if it is not matching structure and type.</p>
<p>5: Finally take the <code>recipe</code> and add to our <code>recipes</code> atom as a key/value pair of id/recipe.</p>
<p>6: Return the recipe.</p>
<p>Lets see it in action:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">
simple-api.models&gt; (<span style="color:#a6e22e">add!</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;All American Beef Taco&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com/recipes/alton-brown/all-american-beef-taco-recipe.html&#34;</span> <span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;Food\
</span><span style="color:#e6db74">Network&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>}})
{<span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;FoodNetwork&#34;</span>}, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;All American Beef Taco&#34;</span>, <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com/recipes/alton-brown/all-american-b\
</span><span style="color:#e6db74">eef-taco-recipe.html&#34;</span>, <span style="color:#e6db74">:id</span> <span style="color:#ae81ff">1</span>}

simple-api.models&gt; <span style="color:#f92672">@</span>recipes
{<span style="color:#ae81ff">1</span> {<span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;FoodNetwork&#34;</span>}, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;All American Beef Taco&#34;</span>, <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com/recipes/alton-brown/all-america\
</span><span style="color:#e6db74">n-beef-taco-recipe.html&#34;</span>, <span style="color:#e6db74">:id</span> <span style="color:#ae81ff">1</span>}}

simple-api.models&gt; <span style="color:#f92672">@</span>id-seq
<span style="color:#ae81ff">1</span>
</code></pre></div><p>We add a recipe with all valid data. Then examine the two atoms: <code>@recipes</code> and <code>@id-seq</code> and both are correct.</p>
<p>Lets add another recipe:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">simple-api.models&gt; (<span style="color:#a6e22e">add!</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;Mexican Grilled corn&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com/recipes/tyler-florence/mexican-grilled-corn-recipe.html&#34;</span> <span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;FoodN\
</span><span style="color:#e6db74">etwork&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>}})
{<span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;FoodNetwork&#34;</span>}, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;Mexican Grilled corn&#34;</span>, <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com/recipes/tyler-florence/mexican-grill\
</span><span style="color:#e6db74">ed-corn-recipe.html&#34;</span>, <span style="color:#e6db74">:id</span> <span style="color:#ae81ff">2</span>}

simple-api.models&gt; <span style="color:#f92672">@</span>recipes
{<span style="color:#ae81ff">2</span> {<span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;FoodNetwork&#34;</span>}, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;Mexican Grilled corn&#34;</span>, <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com/recipes/tyler-florence/mexican-gr\
</span><span style="color:#e6db74">illed-corn-recipe.html&#34;</span>, <span style="color:#e6db74">:id</span> <span style="color:#ae81ff">2</span>}, <span style="color:#ae81ff">1</span> {<span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com&#34;</span>, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;FoodNetwork&#34;</span>}, <span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;All American Beef Taco&#34;</span>, <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;http://www.foodnetwork.com\
</span><span style="color:#e6db74">/recipes/alton-brown/all-american-beef-taco-recipe.html&#34;</span>, <span style="color:#e6db74">:id</span> <span style="color:#ae81ff">1</span>}}

simple-api.models&gt; <span style="color:#f92672">@</span>id-seq
<span style="color:#ae81ff">2</span>
</code></pre></div><p>Here's the tests I wrote for this function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#a6e22e">use-fixtures</span> <span style="color:#e6db74">:each</span>
  (<span style="color:#66d9ef">fn </span>[tests]
    (<span style="color:#a6e22e">add!</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;test&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;test.com&#34;</span> <span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;mom&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;mom.com&#34;</span>}})
  (<span style="color:#a6e22e">tests</span>)))


(<span style="color:#a6e22e">deftest</span> test-repository
  (<span style="color:#a6e22e">testing</span> <span style="color:#e6db74">&#34;adding recipe&#34;</span>
    (<span style="color:#66d9ef">let </span>[recipe {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;test more&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;testmore.com&#34;</span> <span style="color:#e6db74">:source</span> {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">&#34;mom&#34;</span> <span style="color:#e6db74">:url</span> <span style="color:#e6db74">&#34;mom.com&#34;</span>}}
          r (<span style="color:#a6e22e">add!</span> recipe)]
    (<span style="color:#a6e22e">is</span> (= <span style="color:#ae81ff">2</span> (<span style="color:#a6e22e">recipe-count</span>))))))

</code></pre></div><p>The test fixture adds one in, and then my test adds another making it count to be equal to 2. I'm not really liking how I wrote this test&hellip;but it works. Suggestions?</p>
<p>BTW, here's the the <code>recipe-count</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defn </span>recipe-count []
  (count <span style="color:#f92672">@</span>recipes))
</code></pre></div><p>Now lets write a function to return a vector of recipe maps:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defn </span>get-recipes [] (-&gt; <span style="color:#f92672">@</span>recipes
                         vals
                         reverse))
</code></pre></div><p>In the code I found as inspiration for <a href="https://github.com/metosin/compojure-api-examples/blob/master/src/compojure/api/examples/domain.clj">this</a> the author doesn't use the <code>@</code> but passes it to <code>deref</code> &hellip; I think I like using the spiral as it results in shorter code. Any reason why one is better than the other?</p>
<p>Now a function to return just one recipe by id:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defn </span>get-recipe [id] (<span style="color:#f92672">@</span>recipes id))
</code></pre></div><p>Since the key is just the id it is a simple task to look up by id.</p>
<p>Now, the function to update a recipe:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defn </span>update! [recipe]
  (<span style="color:#66d9ef">let </span>[recipe (<span style="color:#a6e22e">coerce!</span> Recipe recipe)]
    (<span style="color:#a6e22e">swap!</span> recipes assoc (<span style="color:#e6db74">:id</span> recipe) recipe)
    (<span style="color:#a6e22e">get-recipe</span> (<span style="color:#e6db74">:id</span> recipe))))

</code></pre></div><p>Swap here just takes the recipe given and puts it in place according to id. Not too complicated here.</p>
<p>Finally, deleting a recipe by id:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clj" data-lang="clj">(<span style="color:#66d9ef">defn </span>delete! [id] (<span style="color:#a6e22e">swap!</span> recipes dissoc id) nil)
</code></pre></div><p>Disassociate the value at id and return nil.</p>
<p>I was pretty happy with how these functions turned out, and I could easily replace them with korma or honeysql when I was ready. I debated calling get-recipe get! and get-recipes get-all! but since those are not desructive like add, update, delete I thought it was fine to leave them.</p>
<p>I'm still learning best and idomatic clojure, so please speak up if you have suggestions! I will be using this <a href="https://github.com/rubygeek/simple-api">simple-api</a> in future blog post as I start to write about <a href="http://clojure-liberator.github.io/liberator/">liberator</a> and see my <a href="https://github.com/rubygeek/simple-api/blob/master/test/simple_api/models_test.clj">tests</a> for the rest of the functions.</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
