<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Weirdness and Coolness in Rails - Rubygeek</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Weirdness and Coolness in Rails" />
<meta property="og:description" content="Coolness First the cool thing&hellip; and I think I have a good reason for this&hellip; I have a model that is not tied to any particular table, but is a summary table for about 8 tables. Rather than cluttering up my controller with a bunch of stuff, I am putting into a model (keeping REST in mind). I could have put it in the lib dir as a module.. but.. I thought i&#39;d try it in the models dir, so i don&#39;t have to require it etc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rubygeek.com/post/2007-07-27-weirdness-and-coolness-in-rails/" />
<meta property="article:published_time" content="2007-07-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2007-07-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Weirdness and Coolness in Rails"/>
<meta name="twitter:description" content="Coolness First the cool thing&hellip; and I think I have a good reason for this&hellip; I have a model that is not tied to any particular table, but is a summary table for about 8 tables. Rather than cluttering up my controller with a bunch of stuff, I am putting into a model (keeping REST in mind). I could have put it in the lib dir as a module.. but.. I thought i&#39;d try it in the models dir, so i don&#39;t have to require it etc."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://rubygeek.comcss/main.css" />

	
		<script src="http://rubygeek.comjs/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="http://rubygeek.com">Rubygeek</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">27</span>
							<span class="rest">Jul 2007</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Weirdness and Coolness in Rails</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h2 id="coolness">Coolness</h2>
<p>First the cool thing&hellip; and I think I have a good reason for this&hellip; I have a model that is not tied to any particular table, but is a summary table for about 8 tables. Rather than cluttering up my controller with a bunch of stuff, I am putting into a model (keeping REST in mind). I could have put it in the lib dir as a module.. but.. I thought i'd try it in the models dir, so i don't have to require it etc. And later I realized I need a bunch of fixtures for it, so I think its pretty handy as a model. Of course, I took out the base class of active record</p>
<p>app/model/summary.rb</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Summary</span>
   <span style="color:#66d9ef">attr_reader</span> <span style="color:#e6db74">:date_from</span>, <span style="color:#e6db74">:date_to</span>
   <span style="color:#66d9ef">attr_writer</span> <span style="color:#e6db74">:date_from</span>, <span style="color:#e6db74">:date_to</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">has_dates?</span>
    (self<span style="color:#f92672">.</span>date_from <span style="color:#f92672">&amp;&amp;</span> self<span style="color:#f92672">.</span>date_to) ? <span style="color:#66d9ef">true</span> : <span style="color:#66d9ef">false</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">job_count</span>
    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>has_dates?
       <span style="color:#66d9ef">Job</span><span style="color:#f92672">.</span>count(<span style="color:#e6db74">:conditions</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">completed_at BETWEEN ? and ?</span><span style="color:#e6db74">&#34;</span>, self<span style="color:#f92672">.</span>date_from, self<span style="color:#f92672">.</span>date_to<span style="color:#f92672">]</span>)
    <span style="color:#66d9ef">else</span>
      <span style="color:#66d9ef">Job</span><span style="color:#f92672">.</span>count(<span style="color:#e6db74">:conditions</span> <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">completed_at IS NOT NULL</span><span style="color:#e6db74">&#34;</span>)
   <span style="color:#66d9ef">end</span>
   
   <span style="color:#f92672">...</span>
<span style="color:#66d9ef">end</span>

</code></pre></div><p>I might want to get the count of jobs for ALL time or a data range, so if there are dates set, it uses those. In addition to jobs, I need to do some &lsquo;not so easy&rdquo; counting of other date and so i started changing my test fixtures to something like this:</p>
<p>test/fixtures/summary_report/jobs.yaml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#f92672">&lt;</span><span style="color:#e6db74">% 1.upto(30) </span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>num<span style="color:#f92672">|</span> <span style="color:#e6db74">%&gt;
</span><span style="color:#e6db74">job_&lt;%=num%&gt;</span>:
  id: <span style="color:#f92672">&lt;</span><span style="color:#e6db74">%= num %&gt;
</span><span style="color:#e6db74">  created_at: &lt;%=</span>(<span style="color:#66d9ef">Time</span><span style="color:#f92672">.</span>now <span style="color:#f92672">-</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672"></span>)<span style="color:#f92672">.</span>to_s(<span style="color:#e6db74">:db</span>) <span style="color:#e6db74">%&gt;
</span><span style="color:#e6db74">  finished_at: &lt;%= Time.now.to_s(:db) %&gt;</span>
  name: <span style="color:#66d9ef">One</span> more number <span style="color:#f92672">&lt;</span><span style="color:#f92672">%=</span> num <span style="color:#e6db74">%&gt; Awesome Job
</span><span style="color:#e6db74">&lt;% end %&gt;</span>
</code></pre></div><p>I have a bunch of other tests and I found one of them was not quite right, and my additional fixtures for the summary report messed it up. So I made a directory in test/fixtures/summary_report and then loaded the fixed in my summary test as such:</p>
<p>test/unit/summary_test.rb</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>dirname(__FILE__) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/../test_helper&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SummaryTest</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">Test</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Unit</span><span style="color:#f92672">::</span><span style="color:#66d9ef">TestCase</span>
  fixtures <span style="color:#e6db74">&#39;summary_report/jobs&#39;</span>,
            <span style="color:#e6db74">&#39;summary_report/people&#39;</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">setup</span>
    @s <span style="color:#f92672">=</span> <span style="color:#66d9ef">Summary</span><span style="color:#f92672">.</span>new
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e"></span><span style="color:#f92672"></span><span style="color:#a6e22e">test_job_count_all</span>
    assert_equal <span style="color:#ae81ff">50</span><span style="color:#f92672"></span>, @s<span style="color:#f92672">.</span>job_count
  <span style="color:#66d9ef">end</span>
  <span style="color:#f92672">...</span>
</code></pre></div><p>So I put fixtures for a particular set of tests in a directory in fixture. Is there a better way to do this?</p>
<h2 id="weirdness">Weirdness</h2>
<p>I put it in a post I made on <!-- raw HTML omitted -->ruby-forum.com<!-- raw HTML omitted --> but here it is again:</p>
<p>Basically, when I try to use a rails version higher tha 1.1.6 in my vendor/rails directory my migrations don't have &ldquo;varchar&rdquo; they have &ldquo;string&rdquo; !! WTF! &hellip; I even tried sqlite and same thing.</p>
<p>I've searched all over the web and mailing lists and can't find any info
on this problem.</p>
<p>I have a site built with Rails 1.1.6  I ran</p>
<p>rake rails:freeze:edge TAG=rel_1-2-3</p>
<p>I ran db:migrate (on a fresh database)</p>
<pre><code> rake db:migrate VERSION=1 --trace
(in /home/nola/projects/tardis/website/trunk)
** Invoke db:migrate (first_time)
** Invoke environment (first_time)
** Execute environment
** Execute db:migrate
== AddContact: migrating
======================================================
-- create_table(:contacts)
rake aborted!
Mysql::Error: You have an error in your SQL syntax; check the manual
that corresponds to your MySQL server version for the right syntax to
use near 'string DEFAULT NULL, `city` string DEFAULT NULL)
ENGINE=InnoDB' at line 1: CREATE TABLE contacts (`id` int(11) DEFAULT
NULL auto_increment PRIMARY KEY DEFAULT NULL, `name` string DEFAULT
NULL, `city` string DEFAULT NULL) ENGINE=InnoDB
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb:128:in
`log'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/connection_adapters/mysql_adapter.rb:243:in
`execute'
/home/nola/projects/tardis/website/trunk/config/../vendor/plugins/mysql_bigint/lib/mysql_bigint.rb:32:in
`create_table'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/connection_adapters/mysql_adapter.rb:353:in
`create_table'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:275:in
`method_missing'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:259:in
`say_with_time'
/usr/lib/ruby/1.8/benchmark.rb:293:in `measure'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:259:in
`say_with_time'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:273:in
`method_missing'
./db/migrate//001_add_contact.rb:3:in `real_up'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:212:in
`migrate'
/usr/lib/ruby/1.8/benchmark.rb:293:in `measure'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:212:in
`migrate'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:335:in
`migrate'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:330:in
`migrate'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:297:in
`up'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/activerecord/lib/active_record/migration.rb:288:in
`migrate'
/home/nola/projects/tardis/website/trunk/config/../vendor/rails/railties/lib/tasks/databases.rake:4
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:392:in `execute'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:392:in `execute'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:362:in `invoke'
/usr/lib/ruby/1.8/thread.rb:135:in `synchronize'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:355:in `invoke'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:1739:in `top_level'
/usr/lib/ruby/gems/1.8/gems/rake- 0.7.3/lib/rake.rb:1739:in `top_level'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:1761:in
`standard_exception_handling'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:1733:in `top_level'
/usr/lib/ruby/gems/1.8/gems/rake- 0.7.3/lib/rake.rb:1711:in `run'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:1761:in
`standard_exception_handling'
/usr/lib/ruby/gems/1.8/gems/rake-0.7.3/lib/rake.rb:1708:in `run'
/usr/lib/ruby/gems/1.8/gems/rake- 0.7.3/bin/rake:7
/usr/bin/rake:1

----------------------------
</code></pre><p>SO Basically, its trying to put in a sql create statement like this:</p>
<pre><code>CREATE TABLE contacts (
 `id` int(11) DEFAULT NULL auto_increment PRIMARY KEY DEFAULT NULL,
 `name` string DEFAULT NULL,
 `city` string DEFAULT NULL
) ENGINE=InnoDB
</code></pre><p>string? when it should put in VARCHAR(255) .. weird huh?</p>
<p>Here's the migration:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AddContact</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Migration</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">up</span>
    create_table <span style="color:#e6db74">:contacts</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>t<span style="color:#f92672">|</span>
      t<span style="color:#f92672">.</span>column <span style="color:#e6db74">:name</span>, <span style="color:#e6db74">:string</span>
      t<span style="color:#f92672">.</span>column <span style="color:#e6db74">:city</span>, <span style="color:#e6db74">:string</span>
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">down</span>
    drop_table <span style="color:#e6db74">:contacts</span>
  <span style="color:#66d9ef">end</span>
</code></pre></div><p>Any ideas? I've also tried with rel_1-2-0 too&hellip; and get the same
result. I can create a table with ints or no fields just fine. When I
remove vendor/rails then its fine.</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
